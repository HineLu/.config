"use strict";function Q(n){return new Date(+n-6e4*(new Date).getTimezoneOffset()).toJSON().slice(0,19).replace("T"," ")}function X(n,e,i){var o,r,a,c,u,l,f,g,d,p,m,S,w,b,v,T=e.environment,h=T&&T.platform||"",y=T&&parseFloat(T.extension||0)||0,C=y>parseFloat(N.me.qc);if(h&&(h=(""+h).slice(0,10)),confirm(s("confirmImport",[s(true!==i?"backupFile":"recommendedFile"),y>1?s("fileVCVer").replace("*",""+y):"",(y>1?s("fileVCVer_2").replace("*",""+y):"")+(C?s("fileVCNewer"):""),h?s("filePlatform",[s(h)||h[0].toUpperCase()+h.slice(1)]):s("commonPlatform"),n?s("atTime",[Q(n)]):s("before")]))){for(u in null==e.vimSync&&(r=(o=N.Sc("vimSync"))&&confirm(s("keepSyncing")),e.vimSync=r||null,o&&console.log("Before importing: You chose to",r?"keep settings synced.":"stop syncing settings.")),a=function(n,e,t,i){var o=arguments.length>3,r=o?i:t,s=["%s %c%s",n,"color:darkred",e];r="string"!=typeof r||r.length<=72?r:r.slice(0,71).trimRight()+"\u2026",o&&s.push(t),s.push(r),console.log.apply(console,s)},n>1e4?console.info("IMPORT settings saved at %c%s%c.","color:darkblue",Q(n),"color:auto"):console.info("IMPORT settings:",i?"recommended.":"saved before."),(c=function(n){return n.split(" ").forEach(function(n){return delete e[n]})})("name time environment author description"),e)"@"===u[0]&&delete e[u];for(l=localStorage,f=N.Tc,g=_.wh,d=/\r\n?/g,p=l.length;0<=--p;)(u=l.key(p)).includes("|")||u in e||(e[u]=null);for(u in c("findModeRawQuery findModeRawQueryList innerCSS findCSS omniCSS newTabUrl_f hookAccessKeys vomnibarPage_f"),N.Fc)u in e&&(e[N.Fc[u]]=e[u],delete e[u]);for(S in e.vimSync!==N.Sc("vimSync")&&(a("import","vimSync",e.vimSync),N.xc("vimSync",e.vimSync),g.vimSync.oh()),void 0!==(m=g.keyMappings)&&(delete g.keyMappings,g.keyMappings=m),g)if(b=e[u=(w=g[S]).th],delete e[u],null==b?b=f[u]:("string"==typeof f[u]&&(b instanceof Array&&(b=b.join("\n").trimRight()),b=b.replace(d,"\n")),b=w.fh(b,"object"==typeof f[u])),w.gh(N.Sc(u),b)){if(w.ih)continue;w.oh()}else a("import",u,b),N.xc(u,b),u in N.Rc&&_.ph.push(u),w.oh(),w.uh&&w.uh();for(u in e)if(null!=(b=e[u]))"string"==typeof f[u]&&(b instanceof Array&&(b=b.join("\n").trimRight()),b=b.replace(d,"\n")),u in f?N.Sc(u)!==b&&(N.xc(u,b),a("update",u,b)):(l.setItem(u,b),a("save",u,b));else{if(u in f){if(b=f[u],N.Sc(u)!==b){N.xc(u,b),a("reset",u,b);continue}b=N.Sc(u)}else b=l.getItem(u);l.removeItem(u),a("remove",u,":=",b)}t("#saveOptions").onclick(false),t("#advancedOptionsButton").getAttribute("aria-checked")!==""+N.Sc("showAdvancedOptions")&&t("#advancedOptionsButton").onclick(null,true),console.info("IMPORT settings: finished."),(v=window.VDom&&VCui.Ut&&VCui.Ut.querySelector("#HClose"))&&(v.click(),t("#showCommands").click()),window.VHud&&VHud.ri(98,1e3)}else window.VHud&&VHud.ri(97,1e3)}function q(n,e,i){var o,r,a,c,l,f=null,g=null,d="";try{(o=K(i?e:e.replace(/\xa0/g," ")))instanceof Error?g=o:o?f=o:d=s("notJSON")}catch(n){g=n}return null!=g&&(d=(r=/^(\d+):(\d+)$/.exec(d=g?(g.message||g)+"":s("exc")+(""!==g?g:s("unknown"))))?s("JSONParseError",[r[1],r[2]]):d),f?(n=+new Date(f&&f.time||("object"==typeof n?+n:n))||0,"Vimium C"!==f.name&&"Vimium++"!==f.name||n<1e4&&n>0?(d=s("notVCJSON"),alert(d)):(a=_.wh.keyMappings.ah?1:new Promise(function(n){var e=t("script[src*=options_checker]")||B("options_checker.js"),i=function(){e.removeEventListener("load",i),n(1)};V.Vh="",e.addEventListener("load",i)}),c=n,l=f,void Promise.all([u.r.Ma("Commands"),u.r.Ma("Exclusions"),a]).then(function(){setTimeout(X,17,c,l,i)}))):alert(d)}function K(n){function e(){return/a?/.test("")}function t(n){for(var e=n.length;o.length<e;o+=o);return o.slice(0,e)}var i,o,r,s,a,c,u,l=/[^\r\n]+/g;if(!n||!(n=n.trimRight()))return null;o=" ";try{return r=JSON.parse(n.replace(/"(?:\\[\\\"]|[^"])*"|'(?:\\[\\\']|[^'])*'|\/\/[^\r\n]*|\/\*[^]*?\*\/|#[^\r\n]*/g,function(n){var e=n[0];return"/"===e||"#"===e?n.startsWith("/*")?n.replace(l,t):t(n):n})),e(),r}catch(n){if(i=/\b(?:position (\d+)|line (\d+) column (\d+))/.exec(n+""),e(),!i||!i[0])throw n}return i[2]?(s=+i[2],a=+i[3]):+i[1]>0?(c=n.includes("\r")?n.includes("\r\n")?"\r\n":"\r":"\n",a=(u=n.slice(0,+i[1]).split(c))[(s=u.length)-1].length+1):s=a=1,new SyntaxError(s+":"+a)}var Y,W;t("#showCommands").onclick=function(n){var e,t,i;if(window.VDom&&VDom._){if(t=VCui.Ut,n&&n.preventDefault(),t&&(e=t.querySelector("#HClose"))&&(i=null!=t.querySelector(".HelpCommandName"),G(e),i))return;VApi.Qt({H:12}),n||setTimeout(function(){var n=VCui.Ut&&VCui.Ut.querySelector("#HelpDialog");n&&n.querySelector("#HClose").addEventListener("click",function(){location.hash=""})},100)}},J.prototype.Vg=function(n){var e,t,i,o,r,a,c,u,l;if(!n||!this.b_){for(t=/^([:^]?[a-z\-?*]+:\/\/)?((?:[^\/]|\/])+)(\/[^\]].*|\/?$)/,i=/\\\./g,a=0,c=e=this.vh();a<c.length;a++)(r=t.exec(o=(u=c[a]).pattern.replace("(?:[^./]+\\.)*?","*.")))&&r[1]&&r[2]&&(o=r[3]?r[3].replace(i,"."):"",(r=r[2].replace(i,".").split(".")).reverse(),o=r.join(".")+o),u.kt=o;e.sort(function(n,e){return n.kt<e.kt?-1:n.kt===e.kt?0:1}),this.sh(e),this.nh(),n&&(l=this,this.b_=setTimeout(function(n,e){n.firstChild.data=e,l.b_=0},1e3,n,n.firstChild.data),n.firstChild.data=s("o3_2"))}},t("#exclusionSortButton").onclick=function(){return _.wh.exclusionRules.Vg(this)},Y="",window.addEventListener("unload",function(){Y&&URL.revokeObjectURL(Y)}),t("#exportButton").onclick=function(n){var e,t,i,o,r,s,a,c,u,l,f,g,d,p,_,m,S;for(Y&&(URL.revokeObjectURL(Y),Y=""),t=!!n&&(n.ctrlKey||n.metaKey||n.shiftKey),i=new Date,(e=Object.create(null)).name="Vimium C",t||(e["@time"]=i.toLocaleString(),e.time=i.getTime()),e.environment={extension:N.me.qc,platform:N.me.ts},e.environment.chrome=R,o=[],r=localStorage,s=N.Tc,a=0,c=r.length;a<c;a++)(u=r.key(a)).includes("|")||u.endsWith("_f")||"findModeRawQueryList"===u||u.endsWith("CSS")||o.push(u);for(o.sort(),l=0,f=o;l<f.length;l++)g=r.getItem(u=f[l]),"string"!=typeof s[u]?e[u]=u in s?N.Sc(u):g:g.includes("\n")?(e[u]=g.split("\n")).push(""):e[u]=g;d=JSON.stringify(e,null,"\t"),p=Q(i),"win"===e.environment.platform&&(d=d.replace(/\n/g,"\r\n")),e=null,_="vimium_c-",_+=t?"settings":p.replace(/[\-:]/g,"").replace(" ","_"),_+=".json",m=new Blob([d],{type:"application/json",endings:"native"}),(S=document.createElement("a")).download=_,S.href=URL.createObjectURL(m),G(S),Y=S.href,console.info("EXPORT settings to %c%s%c at %c%s%c.","color:darkred",_,"color:auto","color:darkblue",p,"color:auto")},(W=t("#settingsFile")).onclick=null,W.onchange=function(){var n,e,t,i=this.files[0];this.value="",i&&(n=_.wh.vimSync.gl?102400:10485760,i.size&&i.size>n?alert(s("JSONTooLarge",[i.name,n/1024])):(e=new FileReader,t=i.lastModified||i.lastModifiedDate||0,e.onload=function(){return q(t,this.result,false)},e.readAsText(i)))},(W=t("#importOptions")).onclick=null,W.onchange=function(){var n,e;t("#importButton").focus(),"exported"!==this.value?(n="../settings_template.json",R>=47?fetch(n).then(function(n){return n.text()}).then(function(n){return q(0,n,true)}):((e=new XMLHttpRequest).open("GET",n,true),e.responseType="text",e.onload=function(){return q(0,this.responseText,true)},e.send())):G(t("#settingsFile"))},W=null,window._d&&(function(){var n,e=window._d;delete window._d,(n=t(e[0])).onclick&&n.onclick(e[1])})();